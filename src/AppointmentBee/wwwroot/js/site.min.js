var app=angular.module("AngularAuthApp",["ngRoute","LocalStorageModule","angular-loading-bar"]);app.config(function(e){e.when("/home",{controller:"homeController",templateUrl:"/app/views/home.html"}),e.when("/login",{controller:"loginController",templateUrl:"/app/views/login.html"}),e.when("/signup",{controller:"signupController",templateUrl:"/app/views/signup.html"}),e.when("/appointments",{controller:"appointmentsController",templateUrl:"/app/views/appointments.html"}),e.otherwise({redirectTo:"/home"})});var serviceBase="http://calrest.azurewebsites.net/";app.constant("serverSettings",{serviceBaseUri:serviceBase}),app.run(["authService",function(e){e.fillAuthData()}]),app.config(function(e){e.interceptors.push("authInterceptorService")}),app.controller("appointmentsController",["$scope","appointmentsService","calendarService","serverSettings",function(e,t,n,o){var r=o.serviceBaseUri;e.appointments=[];var a=function(){t.getAppointments().then(function(t){e.appointments=t.data},function(e){})},i=function(){n.getUserCalendar().then(function(e){s(e)})},s=function(e){$.connection.hub.url=r+"signalr";var t=$.connection.appointmentHub;t.client.newAppointment=function(e){a(),$.notify({title:"<strong>"+e.Creator.Name+"</strong> added an appointment.",message:"<p>"+e.StartDate+"</p>",icon:"glyphicon glyphicon-plus"},{type:"info",placement:{from:"bottom",align:"right"}})},$.connection.hub.logging=!0,$.connection.hub&&$.connection.hub.state===$.signalR.connectionState.disconnected&&$.connection.hub.start().done(function(){t.server.subscribeToCalendar(e)})};a(),i()}]),app.controller("homeController",["$scope",function(e){}]),app.controller("indexController",["$scope","$location","authService",function(e,t,n){e.logOut=function(){n.logOut(),t.path("/home")},e.authentication=n.authentication}]),app.controller("loginController",["$scope","$location","authService",function(e,t,n){e.loginData={userName:"",password:""},e.message="",e.login=function(){n.login(e.loginData).then(function(e){t.path("/appointments")},function(t){e.message=t.error_description})}}]),app.controller("signupController",["$scope","$location","$timeout","authService",function(e,t,n,o){e.savedSuccessfully=!1,e.message="",e.registration={userName:"",password:"",confirmPassword:""},e.signUp=function(){o.saveRegistration(e.registration).then(function(t){e.savedSuccessfully=!0,e.message="User has been registered successfully, you will be redicted to login page in 2 seconds.",r()},function(t){var n=[];for(var o in t.data.ModelState)for(var r=0;r<t.data.ModelState[o].length;r++)n.push(t.data.ModelState[o][r]);e.message=n.join(" ")})};var r=function(){var e=n(function(){n.cancel(e),t.path("/login")},2e3)}}]),app.factory("appointmentsService",["$http","serverSettings",function(e,t){var n=t.serviceBaseUri,o={},r=function(){return e.get(n+"api/appointments").then(function(e){return e})};return o.getAppointments=r,o}]),app.factory("authInterceptorService",["$q","$location","localStorageService",function(e,t,n){var o={},r=function(e){e.headers=e.headers||{};var t=n.get("authorizationData");return t&&(e.headers.Authorization="Bearer "+t.token),e},a=function(n){return 401===n.status&&t.path("/login"),e.reject(n)};return o.request=r,o.responseError=a,o}]),app.factory("authService",["$http","$q","localStorageService","serverSettings",function(e,t,n,o){var r=o.serviceBaseUri,a={},i={isAuth:!1,userName:""},s=function(t){return u(),e.post(r+"api/account/register",t).then(function(e){return e})},c=function(o){var a="grant_type=password&username="+o.userName+"&password="+o.password,s=t.defer();return e.post(r+"token",a,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){n.set("authorizationData",{token:e.access_token,userName:o.userName}),i.isAuth=!0,i.userName=o.userName,s.resolve(e)}).error(function(e,t){u(),s.reject(e)}),s.promise},u=function(){n.remove("authorizationData"),i.isAuth=!1,i.userName="",$.connection.hub.stop()},p=function(){var e=n.get("authorizationData");e&&(i.isAuth=!0,i.userName=e.userName)};return a.saveRegistration=s,a.login=c,a.logOut=u,a.fillAuthData=p,a.authentication=i,a}]),app.factory("calendarService",["$http","serverSettings",function(e,t){var n=t.serviceBaseUri,o={},r=function(){return e.get(n+"api/calendars").then(function(e){return e.data.Id})};return o.getUserCalendar=r,o}]);