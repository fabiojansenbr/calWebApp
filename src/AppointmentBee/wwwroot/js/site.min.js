var app=angular.module("AngularAuthApp",["ngRoute","LocalStorageModule","angular-loading-bar","ui.calendar"]);app.config(function(e){e.when("/home",{controller:"homeController",templateUrl:"/app/views/home.html"}),e.when("/login",{controller:"loginController",templateUrl:"/app/views/login.html"}),e.when("/signup",{controller:"signupController",templateUrl:"/app/views/signup.html"}),e.when("/appointments",{controller:"appointmentsController",templateUrl:"/app/views/appointments.html"}),e.otherwise({redirectTo:"/home"})});var serviceBase="http://calrest.azurewebsites.net/";app.constant("serverSettings",{serviceBaseUri:serviceBase}),app.run(["authService",function(e){e.fillAuthData()}]),app.config(function(e){e.interceptors.push("authInterceptorService")}),app.controller("appointmentsController",["$scope","appointmentsService","calendarService","serverSettings",function(e,t,n,a){function r(e,t){var n=moment(t,"HH:mm");$(".fc-body .fc-slats table tr").each(function(t){$(this).find("td.fc-widget-content").eq(0).html("<span>"+n.format("HH:mm")+"</span>"),n.add(e,"minutes")})}var o=a.serviceBaseUri;e.appointments=[];var i=function(){t.getAppointments().then(function(t){e.appointments=t.data,e.eventSources[0]=t.data},function(e){})},s=function(){n.getUserCalendar().then(function(e){c(e)})},c=function(e){$.connection.hub.url=o+"signalr";var t=$.connection.appointmentHub;t.client.newAppointment=function(e){i(),$.notify({title:"<strong>"+e.Creator.Name+"</strong> added an appointment.",message:"<p>"+e.StartDate+"</p>",icon:"glyphicon glyphicon-plus"},{type:"info",placement:{from:"bottom",align:"right"}})},$.connection.hub.logging=!0,$.connection.hub&&$.connection.hub.state===$.signalR.connectionState.disconnected&&$.connection.hub.start().done(function(){t.server.subscribeToCalendar(e)})};e.changeView=function(e,t){uiCalendarConfig.calendars[t].fullCalendar("changeView",e)},e.renderCalender=function(e){uiCalendarConfig.calendars[e]&&uiCalendarConfig.calendars[e].fullCalendar("render")},e.eventDataTransform=function(e){var t={title:"",start:e.StartDate,end:e.EndDate,className:"eventAvailable"};return e.Patient&&(t.title=e.Patient.PatientName),0==e.IsAvailable&&(t.className="eventUnavailable",t.title=e.AppointmentNote?e.AppointmentNote:"Unavailable"),$.extend(e,t)},e.viewRender=function(e,t){r(45,"08:00:00")},e.dayClick=function(e,t,n){},e.uiConfig={calendar:{height:550,editable:!0,header:{left:"title",center:"",right:"today prev,next"},defaultView:"agendaWeek",slotLabelFormat:"hh:mm",minTime:"08:00:00",maxTime:"20:00:00",slotDuration:"00:45:00",slotLabelInterval:"00:45:00",snapDuration:"00:45:00",weekends:!1,displayEventEnd:!1,timeFormat:"HH:mm",eventDataTransform:e.eventDataTransform,changeView:e.changeView,renderCalender:e.renderCalender,viewRender:e.viewRender,dayClick:e.dayClick}},e.eventSources=[],i(),s()}]),app.controller("homeController",["$scope",function(e){}]),app.controller("indexController",["$scope","$location","authService",function(e,t,n){e.logOut=function(){n.logOut(),t.path("/home")},e.authentication=n.authentication}]),app.controller("loginController",["$scope","$location","authService",function(e,t,n){e.loginData={userName:"",password:""},e.message="",e.login=function(){n.login(e.loginData).then(function(e){t.path("/appointments")},function(t){e.message=t.error_description})}}]),app.controller("signupController",["$scope","$location","$timeout","authService",function(e,t,n,a){e.savedSuccessfully=!1,e.message="",e.registration={userName:"",password:"",confirmPassword:""},e.signUp=function(){a.saveRegistration(e.registration).then(function(t){e.savedSuccessfully=!0,e.message="User has been registered successfully, you will be redicted to login page in 2 seconds.",r()},function(t){var n=[];for(var a in t.data.ModelState)for(var r=0;r<t.data.ModelState[a].length;r++)n.push(t.data.ModelState[a][r]);e.message=n.join(" ")})};var r=function(){var e=n(function(){n.cancel(e),t.path("/login")},2e3)}}]),app.factory("appointmentsService",["$http","serverSettings",function(e,t){var n=t.serviceBaseUri,a={},r=function(){return e.get(n+"api/appointments").then(function(e){return e})};return a.getAppointments=r,a}]),app.factory("authInterceptorService",["$q","$location","localStorageService",function(e,t,n){var a={},r=function(e){e.headers=e.headers||{};var t=n.get("authorizationData");return t&&(e.headers.Authorization="Bearer "+t.token),e},o=function(n){return 401===n.status&&t.path("/login"),e.reject(n)};return a.request=r,a.responseError=o,a}]),app.factory("authService",["$http","$q","localStorageService","serverSettings",function(e,t,n,a){var r=a.serviceBaseUri,o={},i={isAuth:!1,userName:""},s=function(t){return l(),e.post(r+"api/account/register",t).then(function(e){return e})},c=function(a){var o="grant_type=password&username="+a.userName+"&password="+a.password,s=t.defer();return e.post(r+"token",o,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){n.set("authorizationData",{token:e.access_token,userName:a.userName}),i.isAuth=!0,i.userName=a.userName,s.resolve(e)}).error(function(e,t){l(),s.reject(e)}),s.promise},l=function(){n.remove("authorizationData"),i.isAuth=!1,i.userName="",$.connection.hub.stop()},u=function(){var e=n.get("authorizationData");e&&(i.isAuth=!0,i.userName=e.userName)};return o.saveRegistration=s,o.login=c,o.logOut=l,o.fillAuthData=u,o.authentication=i,o}]),app.factory("calendarService",["$http","serverSettings",function(e,t){var n=t.serviceBaseUri,a={},r=function(){return e.get(n+"api/calendars").then(function(e){return e.data.Id})};return a.getUserCalendar=r,a}]);