var app=angular.module("AngularAuthApp",["ngRoute","LocalStorageModule","angular-loading-bar","ui.calendar","ngMaterial"]);app.config(function(e,t){e.when("/home",{controller:"homeController",templateUrl:"/app/views/home.html"}),e.when("/login",{controller:"loginController",templateUrl:"/app/views/login.html"}),e.when("/signup",{controller:"signupController",templateUrl:"/app/views/signup.html"}),e.when("/appointments",{controller:"appointmentsController",templateUrl:"/app/views/appointments.html"}),e.otherwise({redirectTo:"/home"}),t.theme("default").primaryPalette("blue")});var serviceBase="http://calrest.azurewebsites.net/";app.constant("serverSettings",{serviceBaseUri:serviceBase}),app.run(["authService",function(e){e.fillAuthData()}]),app.config(function(e){e.interceptors.push("authInterceptorService")}),app.controller("appointmentsController",["$scope","appointmentsService","calendarService","serverSettings","$mdDialog","$mdMedia",function(e,t,n,a,o,r){function i(e,t){var n=moment(t,"HH:mm");$(".fc-body .fc-slats table tr").each(function(t){$(this).find("td.fc-widget-content").eq(0).html("<span>"+n.format("HH:mm")+"</span>"),n.add(e,"minutes")})}var s=a.serviceBaseUri;e.appointments=[];var c=function(){e.oNewAppointment={StartDate:"",EndDate:"",IsAvailable:!0}},l=function(){t.getAppointments().then(function(t){e.appointments=t.data,e.eventSources[0]=t.data},function(e){})},u=function(e){t.postAppointment(e).then(function(e){l()},function(e){})},p=function(){n.getUserCalendar().then(function(e){d(e)})},d=function(e){$.connection.hub.url=s+"signalr";var t=$.connection.appointmentHub;t.client.newAppointment=function(e){l(),$.notify({title:"<strong>"+e.Creator.Name+"</strong> added an appointment.",message:"<p>"+e.StartDate+"</p>",icon:"glyphicon glyphicon-plus"},{type:"info",placement:{from:"bottom",align:"right"}})},$.connection.hub.logging=!0,$.connection.hub&&$.connection.hub.state===$.signalR.connectionState.disconnected&&$.connection.hub.start().done(function(){t.server.subscribeToCalendar(e)})};e.changeView=function(e,t){uiCalendarConfig.calendars[t].fullCalendar("changeView",e)},e.renderCalender=function(e){uiCalendarConfig.calendars[e]&&uiCalendarConfig.calendars[e].fullCalendar("render")},e.eventDataTransform=function(e){var t={id:e.Id,title:"",start:e.StartDate,end:e.EndDate,className:"eventAvailable"};return e.Patient&&(t.title=e.Patient.PatientName),0==e.IsAvailable&&(t.className="eventUnavailable",t.title=e.AppointmentNote?e.AppointmentNote:"Unavailable"),$.extend(e,t)},e.viewRender=function(e,t){i(45,"08:00:00")},e.showAddAppointmentDialog=function(t,n){var a=!0;c(),e.oNewAppointment.StartDate=t,e.oNewAppointment.EndDate=n,o.show({templateUrl:"dialog1.tmpl.html",scope:e,preserveScope:!0,bindToController:!0,clickOutsideToClose:!0,fullscreen:a}).then(function(t){u(e.oNewAppointment),c()},function(){c()})},e.uiConfig={calendar:{height:550,editable:!0,header:{left:"title",center:"",right:"today prev,next"},defaultView:"agendaWeek",slotLabelFormat:"hh:mm",minTime:"08:00:00",maxTime:"20:00:00",slotDuration:"00:45:00",slotLabelInterval:"00:45:00",snapDuration:"00:45:00",weekends:!1,displayEventEnd:!1,timeFormat:"HH:mm",eventDataTransform:e.eventDataTransform,changeView:e.changeView,renderCalender:e.renderCalender,viewRender:e.viewRender,selectable:!0,select:e.showAddAppointmentDialog}},e.eventSources=[],l(),p(),e.hide=function(){o.hide()},e.cancel=function(){o.cancel()},e.answer=function(e){o.hide(e)}}]),app.controller("homeController",["$scope",function(e){}]),app.controller("indexController",["$scope","$location","authService",function(e,t,n){e.logOut=function(){n.logOut(),t.path("/home")},e.authentication=n.authentication}]),app.controller("loginController",["$scope","$location","authService",function(e,t,n){e.loginData={userName:"",password:""},e.message="",e.login=function(){n.login(e.loginData).then(function(e){t.path("/appointments")},function(t){e.message=t.error_description})}}]),app.controller("signupController",["$scope","$location","$timeout","authService",function(e,t,n,a){e.savedSuccessfully=!1,e.message="",e.registration={userName:"",password:"",confirmPassword:""},e.signUp=function(){a.saveRegistration(e.registration).then(function(t){e.savedSuccessfully=!0,e.message="User has been registered successfully, you will be redicted to login page in 2 seconds.",o()},function(t){var n=[];for(var a in t.data.ModelState)for(var o=0;o<t.data.ModelState[a].length;o++)n.push(t.data.ModelState[a][o]);e.message=n.join(" ")})};var o=function(){var e=n(function(){n.cancel(e),t.path("/login")},2e3)}}]),app.factory("appointmentsService",["$http","serverSettings",function(e,t){var n=t.serviceBaseUri,a={},o=function(){return e.get(n+"api/appointments").then(function(e){return e})},r=function(t){return e.post(n+"api/appointments",t).then(function(e){return e})};return a.getAppointments=o,a.postAppointment=r,a}]),app.factory("authInterceptorService",["$q","$location","localStorageService",function(e,t,n){var a={},o=function(e){e.headers=e.headers||{};var t=n.get("authorizationData");return t&&(e.headers.Authorization="Bearer "+t.token),e},r=function(n){return 401===n.status&&t.path("/login"),e.reject(n)};return a.request=o,a.responseError=r,a}]),app.factory("authService",["$http","$q","localStorageService","serverSettings",function(e,t,n,a){var o=a.serviceBaseUri,r={},i={isAuth:!1,userName:""},s=function(t){return l(),e.post(o+"api/account/register",t).then(function(e){return e})},c=function(a){var r="grant_type=password&username="+a.userName+"&password="+a.password,s=t.defer();return e.post(o+"token",r,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){n.set("authorizationData",{token:e.access_token,userName:a.userName}),i.isAuth=!0,i.userName=a.userName,s.resolve(e)}).error(function(e,t){l(),s.reject(e)}),s.promise},l=function(){n.remove("authorizationData"),i.isAuth=!1,i.userName="",$.connection.hub.stop()},u=function(){var e=n.get("authorizationData");e&&(i.isAuth=!0,i.userName=e.userName)};return r.saveRegistration=s,r.login=c,r.logOut=l,r.fillAuthData=u,r.authentication=i,r}]),app.factory("calendarService",["$http","serverSettings",function(e,t){var n=t.serviceBaseUri,a={},o=function(){return e.get(n+"api/calendars").then(function(e){return e.data.Id})};return a.getUserCalendar=o,a}]);