var app=angular.module("AngularCalendar",["ngRoute","LocalStorageModule","angular-loading-bar","ui.calendar","ngMaterial","ngMessages","ngAria"]);app.config(function(e,t){e.when("/home",{controller:"homeController",templateUrl:"/app/views/home.html"}),e.when("/login",{controller:"loginController",templateUrl:"/app/views/login.html"}),e.when("/signup",{controller:"signupController",templateUrl:"/app/views/signup.html"}),e.when("/confirmemail",{controller:"confirmController",templateUrl:"/app/views/confirm.html"}),e.when("/appointments",{controller:"appointmentsController",templateUrl:"/app/views/appointments.html"}),e.when("/forgotpassword",{controller:"loginController",templateUrl:"/app/views/forgotpassword.html"}),e.when("/resetpassword",{controller:"passwordResetController",templateUrl:"/app/views/resetpassword.html"}),e.otherwise({redirectTo:"/home"}),t.theme("default").primaryPalette("blue")});var serviceBase="http://calrest.azurewebsites.net/";app.constant("serverSettings",{serviceBaseUri:serviceBase}),app.run(["$rootScope","$location","authService",function(e,t,n){0==n.getAuthStatus()&&n.rememberMe()&&n.autoLogin()["finally"](function(){n.fillAuthData()}),n.getAuthStatus()&&(n.fillAuthData(),e.$on("$routeChangeStart",function(e,o,a){"/home"==o.originalPath&&n.getAuthStatus()&&(e.preventDefault(),t.path("/appointments"))}))}]),app.config(function(e){e.interceptors.push("authInterceptorService")}),app.controller("appointmentsController",["$scope","appointmentsService","calendarService","serverSettings","$mdDialog","$mdMedia","$mdToast","$log","patientsService","$q",function(e,t,n,o,a,i,r,s,c,l){function u(e,t){var n=moment(t,"HH:mm");$(".fc-body .fc-slats table tr").each(function(t){$(this).find("td.fc-widget-content").eq(0).html("<span>"+n.format("HH:mm")+"</span>"),n.add(e,"minutes")})}function p(t){var n,o=t?e.patients.filter(h(t)):e.patients;return e.simulateQuery?(n=l.defer(),$timeout(function(){n.resolve(o)},1e3*Math.random(),!1),n.promise):o}function d(t){""!=t&&null!=t&&(e.oNewAppointment.Patient.PatientName=t,e.selectedItem=null)}function m(t){""!=t&&null!=t&&(e.oNewAppointment.Patient=t,e.oNewAppointment.PatientId=t.Id)}function f(){c.getPatients().then(function(t){e.patients=t.data},function(e){})}function h(e){var t=angular.lowercase(e);return function(e){return 0===e.PatientName.indexOf(t)}}var g=o.serviceBaseUri;e.IsTouchMove=!1,e.DetectTouchScreen=function(){return"ontouchstart"in window||navigator.maxTouchPoints},e.oNewAppointment={StartDate:"",EndDate:"",PatientId:"",Patient:{PatientName:"",PhoneNumber:""},IsAvailable:!0,AppointmentNote:""};var v=function(){e.oNewAppointment={StartDate:"",EndDate:"",PatientId:"",Patient:{PatientName:"",PhoneNumber:""},IsAvailable:!0,AppointmentNote:""},e.searchText="",e.selectedItem=null},w=function(){t.getAppointments().then(function(t){e.eventSources[0]=t.data},function(e){})},C=function(e){t.postAppointment(e).then(function(e){w()})},A=function(e){t.deleteAppointment(e).then(function(t){$("#calendar").fullCalendar("removeEvents",e.Id),$("#calendar").fullCalendar("rerenderEvents")})},D=function(e){t.putAppointment(e).then(function(t){$("#calendar").fullCalendar("renderEvent",e,!1),$("#calendar").fullCalendar("rerenderEvents")})},S=function(){n.getUserCalendar().then(function(e){P(e)})},P=function(e){$.connection.hub.url=g+"signalr";var t=$.connection.appointmentHub;t.client.newAppointment=function(e){w();var t=new Date(e.StartDate);r.show(r.simple().textContent(e.Creator.Name+" added an appointment.  "+t.toUTCString()).position("bottom left").capsule(!0).theme("success-toast").hideDelay(1500))},t.client.deleteAppointment=function(e){$("#calendar").fullCalendar("removeEvents",e.Id),$("#calendar").fullCalendar("rerenderEvents");var t=new Date(e.StartDate);r.show(r.simple().textContent(e.Creator.Name+" removed an appointment.  "+t.toUTCString()).position("bottom left").capsule(!0).theme("error-toast").hideDelay(1500))},t.client.updateAppointment=function(e){$("#calendar").fullCalendar("removeEvents",e.Id),$("#calendar").fullCalendar("renderEvent",e,!1),$("#calendar").fullCalendar("rerenderEvents");var t=new Date(e.StartDate);r.show(r.simple().textContent(e.Creator.Name+" updated an appointment.  "+t.toUTCString()).position("bottom left").capsule(!0).theme("info-toast").hideDelay(1500))},$.connection.hub.logging=!0,$.connection.hub&&$.connection.hub.state===$.signalR.connectionState.disconnected&&$.connection.hub.start().done(function(){t.server.subscribeToCalendar(e)})};e.eventDataTransform=function(e){if(e.Patient){var t={id:e.Id,title:"",start:e.StartDate,end:e.EndDate,className:"eventAvailable"};t.title=e.Patient.PatientName}else var t={id:e.Id,title:"",Patient:{PatientName:"",PhoneNumber:""},start:e.StartDate,end:e.EndDate,className:"eventAvailable"};return 0==e.IsAvailable&&(t.className="eventUnavailable",t.title=e.AppointmentNote?e.AppointmentNote:"Unavailable"),$.extend(e,t)},e.viewRender=function(e,t){u(45,"08:00:00")},e.showAddAppointmentDialog=function(t,n,o){var r=i("sm")||i("xs");v(),o?(o.Patient&&(e.searchText=o.Patient.PatientName),e.oNewAppointment=o,e.oNewAppointment.StartDate=o.start,e.oNewAppointment.EndDate=o.end,o=null):(e.oNewAppointment.StartDate=t,e.oNewAppointment.EndDate=n,e.oNewAppointment.Patient.PatientName="",e.oNewAppointment.Patient.PhoneNumber=""),a.show({templateUrl:"dialog1.tmpl.html",scope:e,preserveScope:!0,bindToController:!0,clickOutsideToClose:!0,fullscreen:r}).then(function(){},function(){v()})},e.dayClick=function(t,n,o){e.IsTouchMove||e.showAddAppointmentDialog(t,t.clone().add(45,"minutes"))},e.eventClick=function(t,n,o){e.showAddAppointmentDialog(null,null,t)},e.select=function(t,n){e.IsTouchMove||e.showAddAppointmentDialog(t,n)},e.changeView=function(e){"today"==e?$("#calendar").fullCalendar("today"):$("#calendar").fullCalendar("changeView",e)},e.viewChanged=function(e){},e.renderCalender=function(e){uiCalendarConfig.calendars[e]&&uiCalendarConfig.calendars[e].fullCalendar("render")},e.eventDateUpdate=function(t,n,o){e.oNewAppointment=t,e.oNewAppointment.source={},e.oNewAppointment.CreatorId=e.oNewAppointment.Creator.Id,e.oNewAppointment.StartDate=t.start,e.oNewAppointment.EndDate=t.end,D(e.oNewAppointment)};var N={height:"auto",header:{left:"prev",center:"title",right:"next"},defaultView:"agendaWeek",slotLabelFormat:"hh:mm",minTime:"08:00:00",maxTime:"20:00:00",slotDuration:"00:45:00",slotLabelInterval:"00:45:00",snapDuration:"00:45:00",weekends:!1,displayEventEnd:!1,timeFormat:"HH:mm",eventDataTransform:e.eventDataTransform,eventDrop:e.eventDateUpdate,eventResize:e.eventDateUpdate,changeView:e.viewChanged,renderCalender:e.renderCalender,viewRender:e.viewRender,eventClick:e.eventClick};e.DetectTouchScreen()?N.dayClick=e.dayClick:(N.selectable=!0,N.selectHelper=!0,N.select=e.select,N.editable=!0),e.uiConfig={calendar:N},e.eventSources=[],w(),S(),e.hide=function(){a.hide()},e.DialogCancel=function(){a.cancel()},e.DialogAddAppointment=function(){e.oNewAppointment.Id?(e.oNewAppointment.source={},e.oNewAppointment.CreatorId=e.oNewAppointment.Creator.Id,D(e.oNewAppointment)):C(e.oNewAppointment),a.hide()},e.DialogDeleteAppointment=function(){e.oNewAppointment.Id&&(A(e.oNewAppointment),a.hide())},e.simulateQuery=!1,e.patients="",f(),e.querySearch=p,e.selectedItemChange=m,e.searchTextChange=d,e.newPatient=function(e){s.info("Create New patient for:"+e)}}]).directive("hbTouchmove",[function(){return function(e,t,n){t.on("touchmove",function(t){e.$apply(function(){e.$eval(n.hbTouchmove)})})}}]).directive("hbTouchend",[function(){return function(e,t,n){t.on("touchend",function(t){e.$apply(function(){e.$eval(n.hbTouchend)})})}}]),app.controller("confirmController",["$scope","$location","$timeout","authService","$mdToast",function(e,t,n,o,a){e.confirmSuccess=!1,e.isProcessing=!0,e.confirmData={userid:t.search().userid,token:t.search().token,email:t.search().email},e.isProcessing=!0,a.show(a.simple().textContent("Confirming your email..").position("top left").capsule(!0).theme("info-toast").hideDelay(3e3)),o.confirmEmail(e.confirmData).then(function(t){if(200==t)if(e.confirmSuccess=!0,e.isProcessing=!0,a.show(a.simple().textContent("Your account is Activated! Logging you in..").position("top left").capsule(!0).theme("success-toast").hideDelay(2e3)),e.confirmData.email==o.getEmail())if(0==o.getAuthStatus()){o.autoLogin().then(function(e){i("/appointments")},function(e){i("/login")})}else i("/appointments");else o.logOut(),i("/login")},function(t){var n=[];for(var o in t.data.ModelState)for(var i=0;i<t.data.ModelState[o].length;i++)n.push(t.data.ModelState[o][i]);a.show(a.simple().textContent("Error Occured: "+n.join(" ")).position("top left").capsule(!0).theme("error-toast").hideDelay(5e4)),e.confirmSuccess=!1,e.isProcessing=!1})["finally"](function(){});var i=function(e){var o=n(function(){n.cancel(o),t.search({}),t.path(e)},2e3)}}]),app.controller("homeController",["$scope","$location","authService",function(e,t,n){}]),app.controller("indexController",["$scope","$location","authService",function(e,t,n){e.logOut=function(){n.logOut(),t.path("/home")},e.authentication=n.authentication}]),app.controller("loginController",["$scope","$location","authService","$mdToast","$timeout",function(e,t,n,o,a){e.loginData={email:"",password:""},e.retrieveSuccess=!1,e.isProcessing=!1,e.login=function(){n.login(e.loginData).then(function(e){t.path("/appointments")},function(e){o.show(o.simple().textContent(e.error_description).position("top left").capsule(!0).theme("error-toast").hideDelay(1200))})},e.retrievePasswordReset=function(){e.isProcessing=!0,n.retrievePasswordReset(e.loginData.email).then(function(t){e.retrieveSuccess=!0,o.show(o.simple().textContent("We just sent a password reset link to "+e.loginData.email).position("top left").capsule(!0).theme("success-toast").hideDelay(2e3)),i("/login")},function(e){o.show(o.simple().textContent(e.statusText).action("ok").highlightAction(!0).position("top left").capsule(!0).theme("error-toast").hideDelay(2e3))})["finally"](function(){e.isProcessing=!1})};var i=function(e){var n=a(function(){a.cancel(n),t.search({}),t.path(e)},2e3)}}]),app.controller("passwordResetController",["$scope","$location","$timeout","authService","$mdToast",function(e,t,n,o,a){e.resetSuccess=!1,e.isProcessing=!1,e.resetPasswordData={userid:t.search().userid,token:t.search().token,email:t.search().email},e.newPassword={password:"",confirmPassword:""},e.passwordReset=function(){e.newPassword.password==e.newPassword.confirmPassword?o.resetPassword(e.newPassword.password,e.resetPasswordData).then(function(t){200==t&&(e.resetSuccess=!0,a.show(a.simple().textContent("Your password is changed. Redirecting you to login page..").position("top left").capsule(!0).theme("success-toast").hideDelay(4e3)),e.isProcessing=!0,i("/login"))},function(t){var n=[];for(var o in t.data.ModelState)for(var i=0;i<t.data.ModelState[o].length;i++)n.push(t.data.ModelState[o][i]);a.show(a.simple().textContent("Error Occured: "+n.join(" ")).action("ok").highlightAction(!0).position("top left").capsule(!0).theme("error-toast").hideDelay(2e3)),e.isProcessing=!1})["finally"](function(){}):a.show(a.simple().textContent("Passwords should match").position("top left").capsule(!0).theme("error-toast").hideDelay(2e3))};var i=function(e){var o=n(function(){n.cancel(o),t.search({}),t.path(e)},2e3)}}]),app.controller("sideNavController",["$mdDialog","$scope","$mdSidenav","$mdBottomSheet","$log",function(e,t,n,o,a,i){t.toggleList=function(){n("left").toggle()},t.openMenu=function(e,t){e(t)}}]),app.controller("signupController",["$scope","$location","$timeout","authService","$mdToast",function(e,t,n,o,a){e.isProcessing=!1,e.savedSuccessfully=!1,e.registration={email:"",fullName:"",password:"",confirmPassword:""},e.signUp=function(){e.isProcessing=!0,o.register(e.registration).then(function(t){e.savedSuccessfully=!0,a.show(a.simple().textContent("We just sent a confirmation email to "+e.registration.email).action("ok").highlightAction(!0).position("top left").capsule(!0).theme("success-toast").hideDelay(25e4))},function(e){var t=[];for(var n in e.data.ModelState)for(var o=0;o<e.data.ModelState[n].length;o++)t.push(e.data.ModelState[n][o]);a.show(a.simple().textContent(t.join(" ")).action("ok").highlightAction(!0).position("top left").capsule(!0).theme("error-toast").hideDelay(25e4))})["finally"](function(){e.isProcessing=!1})}}]),app.factory("appointmentsService",["$http","serverSettings",function(e,t){var n=t.serviceBaseUri,o={},a=function(){return e.get(n+"api/appointments").then(function(e){return e})},i=function(t){return""==t.Patient.PatientName&&""==t.Patient.PhoneNumber&&delete t.Patient,e.post(n+"api/appointments",t).then(function(e){return e})},r=function(t){return e["delete"](n+"api/appointments/"+t.Id,t).then(function(e){return e},function(e){console.error(e.statusText)})},s=function(t){return e.put(n+"api/appointments/"+t.Id,t).then(function(e){return e},function(e){console.error(e.statusText)})};return o.getAppointments=a,o.postAppointment=i,o.deleteAppointment=r,o.putAppointment=s,o}]),app.factory("authInterceptorService",["$q","$location","$injector","localStorageService",function(e,t,n,o){var a={},i=!1,r=function(e){e.headers=e.headers||{};var t=o.get("authorizationData");if(t){var a=n.get("authService");e.headers.Authorization="Bearer "+t.token,a.shouldRefreshToken()&&(i||(i=!0,a.autoLogin().then(function(e){},function(e){})["finally"](function(){i=!1})))}return e},s=function(n){return 401===n.status&&t.path("/login"),e.reject(n)};return a.request=r,a.responseError=s,a}]),app.factory("authService",["$http","$q","localStorageService","serverSettings",function(e,t,n,o){var a=o.serviceBaseUri,i={},r={isAuth:!1,email:""},s={email:"",password:""},c=function(o){d();var i=t.defer();return e.post(a+"api/account/register",o).success(function(e){i.resolve(e),n.set("credentials",{email:o.email,password:o.password})}).error(function(e,t){i.reject(e)})},l=function(o){var i="grant_type=password&username="+o.email+"&password="+o.password,c=t.defer();return e.post(a+"token",i,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){var t=e.userName;n.set("authorizationData",{token:e.access_token,email:t,tokenExpiration:e[".expires"]}),r.isAuth=!0,r.email=t,o.remember&&(n.set("credentials",{email:t,password:o.password}),s.email=t,s.password=o.password),c.resolve(e)}).error(function(e,t){d(),c.reject(e)}),c.promise},u=function(){var e=t.defer(),o=n.get("credentials");return o?(s.email=o.email,s.password=o.password,l(s)):(e.reject(!1),e.promise)},p=function(){var e=n.get("credentials"),t=!1;return t=e?!0:!1},d=function(){m(),$.connection.hub.stop()},m=function(){n.remove("authorizationData"),n.remove("credentials"),r.isAuth=!1,r.email="",s.email="",s.password=""},f=function(){var e=n.get("authorizationData");e&&(r.isAuth=h(),r.email=e.email)},h=function(){var e=n.get("authorizationData");if(e){var t=new Date(e.tokenExpiration),o=new Date;r.isAuth=t>o?!0:!1}else r.isAuth=!1;return r.isAuth},g=function(){var e=n.get("authorizationData"),t=!0;if(e){var o=new Date(e.tokenExpiration),a=new Date,i=Math.floor((o-a)/1e3/60);t=10>i?!0:!1}return t},v=function(t){return e.get(a+"api/account/ConfirmEmail?userid="+t.userid+"&token="+encodeURIComponent(t.token)).then(function(e){return e.status})},w=function(t,n){return e.get(a+"api/account/ResetPassword?userid="+n.userid+"&token="+encodeURIComponent(n.token)+"&newPassword="+t).then(function(e){return e.status})},C=function(){var e=n.get("credentials");return e?n.get("credentials").email:null},A=function(t){return e.get(a+"api/account/RequestPasswordReset?email="+t).then(function(e){return e.status})};return i.register=c,i.login=l,i.autoLogin=u,i.rememberMe=p,i.logOut=d,i.fillAuthData=f,i.getAuthStatus=h,i.shouldRefreshToken=g,i.authentication=r,i.credentials=s,i.confirmEmail=v,i.getEmail=C,i.retrievePasswordReset=A,i.resetPassword=w,i}]),app.factory("calendarService",["$http","serverSettings",function(e,t){var n=t.serviceBaseUri,o={},a=function(){return e.get(n+"api/calendars").then(function(e){return e.data.Id})},i=function(){return e.get(n+"api/account/GetUserInfo").then(function(e){return e})};return o.getUserCalendar=a,o.getUserInfo=i,o}]),app.factory("patientsService",["$http","serverSettings",function(e,t){var n=t.serviceBaseUri,o={},a=function(){return e.get(n+"api/patients").then(function(e){return e})},i=function(t){return e.post(n+"api/patients",t).then(function(e){return e})},r=function(t){return e["delete"](n+"api/patients/"+t.Id,t).then(function(e){return e},function(e){console.error(e.statusText)})},s=function(t){return e.put(n+"api/patients/"+t.Id,t).then(function(e){return e},function(e){console.error(e.statusText)})};return o.getPatients=a,o.postPatient=i,o.deletePatient=r,o.putPatient=s,o}]);